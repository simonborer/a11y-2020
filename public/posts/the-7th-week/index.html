<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
	<link rel="manifest" href="/images/site.webmanifest">
	<title>Week 7 - Routines</title>
	<meta name="description" content="2020 Humber Accessibility/Usability Course">
	<meta name="author" content="Simon Borer">
	
		
		
		<link rel="stylesheet" href="sass/main.scss">
	
</head>
<body>
	
	<main class="post">
		<article>
			<div class="hero hero--page" style="background-image:url('/images/groundhog.jpg')">
				<nav class="page-nav">
					<a class="button small primary page-nav__link" href="https://a11y2020.com">Home</a>
					
					<a class="button small primary page-nav__link" href="/slides//posts/the-7th-week/">Slides</a>
					
				</nav>
				<h1 class="page-title">Week 7 - Routines</h1>
			</div>
			<div class="grid-container">
				<div class="grid-x">
					<div class="cell large-6 large-offset-3 medium-10 medium-offset-1"><!-- raw HTML omitted -->
<p>&ndash; This next bit sets the library database as the
&ndash; default when we run queries. You also don&rsquo;t need
&ndash; to do this.
USE library;<!-- raw HTML omitted --><!-- raw HTML omitted -->
<!-- raw HTML omitted -->
CREATE DATABASE IF NOT EXISTS library;</p>
<p>&ndash; This next bit sets the library database
&ndash; as the default when we run queries.
&ndash; You also don&rsquo;t need to do this.
USE library;<!-- raw HTML omitted -->
<!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<p>DELIMITER // ;</p>
<p>&ndash; Step 2: We name our procedure
&ndash; (<code>insert_book</code>), and define the
&ndash; arguments that we&rsquo;re going to pass in.
CREATE PROCEDURE insert_book(
IN p_title TEXT,
IN p_genre VARCHAR(200),
IN p_author_first_name VARCHAR(50),
IN p_author_last_name VARCHAR(50)
)</p>
<p>&ndash; Step 3: We begin!
BEGIN</p>
<p>&ndash; Step 4: Define variables (placeholders)
&ndash; that we&rsquo;re going to use in the procedure.
DECLARE p_book_id INT;
DECLARE p_author_id INT;</p>
<p>&ndash; Step 5: Populate the variables (using
&ndash; <code>SELECT [value] INTO [variable]</code>)
SELECT MAX(book_id) + 1 INTO p_book_id
FROM books;
SELECT MAX(author_id) + 1 INTO p_author_id
FROM authors;</p>
<p>&ndash; Step 6: Work with our variables.
&ndash; Note that Steps 5 and 6 aren&rsquo;t always
&ndash; one after the other - they&rsquo;re often
&ndash; interwoven.
INSERT INTO authors (author_id, first_name,
last_name)
VALUES (p_author_id, p_author_first_name,
p_author_last_name);</p>
<p>INSERT INTO books (book_id, title, genre)
VALUES (p_book_id, p_title, p_genre);</p>
<p>INSERT INTO authorship (author_id, book_id)
VALUES (p_author_id, p_book_id);</p>
<p>&ndash; Step 7: That&rsquo;s all folks!
&ndash; We use the <code>END</code> statement with our
&ndash; custom delimiter to wrap things up.
END //<!-- raw HTML omitted --><!-- raw HTML omitted -->
<!-- raw HTML omitted -->&ndash; Step 1:
&ndash; We define a delimiter. This is because
&ndash; normally we have &lsquo;;&rsquo; as a way of saying
&ndash; &ldquo;this statement is over&rdquo;, be because this
&ndash; statement contains other statements, we
&ndash; have to define a temporary one.</p>
<p>DELIMITER // ;</p>
<p>&ndash; Step 2: We name our procedure
&ndash; (<code>insert_book</code>), and define the
&ndash; arguments that we&rsquo;re going to pass in.
CREATE PROCEDURE insert_book(
IN p_title TEXT,
IN p_genre VARCHAR(200),
IN p_author_first_name VARCHAR(50),
IN p_author_last_name VARCHAR(50)
)</p>
<p>&ndash; Step 3: We begin!
BEGIN</p>
<p>&ndash; Step 4: Define variables (placeholders)
&ndash; that we&rsquo;re going to use in the procedure.
DECLARE p_book_id INT;
DECLARE p_author_id INT;</p>
<p>&ndash; Step 5: Populate the variables (using
&ndash; <code>SELECT [value] INTO [variable]</code>)
SELECT MAX(book_id) + 1 INTO p_book_id
FROM books;
SELECT MAX(author_id) + 1 INTO p_author_id
FROM authors;</p>
<p>&ndash; Step 6: Work with our variables.
&ndash; Note that Steps 5 and 6 aren&rsquo;t always
&ndash; one after the other - they&rsquo;re often
&ndash; interwoven.
INSERT INTO authors (author_id, first_name,
last_name)
VALUES (p_author_id, p_author_first_name,
p_author_last_name);</p>
<p>INSERT INTO books (book_id, title, genre)
VALUES (p_book_id, p_title, p_genre);</p>
<p>INSERT INTO authorship (author_id, book_id)
VALUES (p_author_id, p_book_id);</p>
<p>&ndash; Step 7: That&rsquo;s all folks!
&ndash; We use the <code>END</code> statement with our
&ndash; custom delimiter to wrap things up.
END //<!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<p>&ndash; Let&rsquo;s start over
DROP PROCEDURE insert_book</p>
<p>&ndash; Same stuff as last time&hellip;
DELIMITER // ;</p>
<p>CREATE PROCEDURE insert_book(
IN p_title TEXT,
IN p_genre VARCHAR(200),
IN p_author_first_name VARCHAR(50),
IN p_author_last_name VARCHAR(50)
)</p>
<p>&ndash; Still the same stuff&hellip;
BEGIN</p>
<p>DECLARE p_book_id INT;
DECLARE p_author_id INT;</p>
<p>&ndash; Something new!
&ndash; We&rsquo;re creating the protocol for
&ndash; what happens when we get an error
&ndash; with the code &lsquo;1242&rsquo;.</p>
<p>DECLARE EXIT HANDLER FOR 1242
BEGIN
&ndash; &lsquo;ROLLBACK&rsquo; means &ldquo;Even if you
&ndash; inserted a bunch of rows already,
&ndash; undo everything if there&rsquo;s an error&rdquo;.
ROLLBACK;</p>
<pre><code>  -- This is the message we return.
    SELECT CONCAT('Looks like ',
      'you have multiple authors ',
      'by the name ', 
      p_author_first_name, ' ',
      p_author_last_name);
END;
</code></pre>
<p>&ndash; This is the same as last time
SELECT MAX(book_id) + 1 INTO p_book_id
FROM books;</p>
<p>&ndash; This is new!</p>
<p>&ndash; If the author already exists&hellip;
IF (
SELECT author_id FROM authors
WHERE first_name = p_author_first_name
AND last_name = p_author_last_name
)</p>
<p>THEN</p>
<p>&ndash; &hellip;select the existing author_id
&ndash; into the p_author_id variable
SELECT author_id INTO p_author_id
FROM authors
WHERE first_name = p_author_first_name
AND last_name = p_author_last_name;</p>
<p>&ndash; Okay, quick aside - remember error 1242?
&ndash; That&rsquo;s the number of the error we get if
&ndash; the above SELECT statement returns more
&ndash; than one result! Aaaaand back to talking
&ndash; about the if/else code:</p>
<p>&ndash; However, if the author doesn&rsquo;t
&ndash; already exist&hellip;
ELSE</p>
<pre><code>-- ...create a new author...
INSERT INTO authors (author_id, 
  first_name, last_name) 
  VALUES (NULL, p_author_first_name, 
    p_author_last_name);
-- ...and then select the new author's 
-- id into the p_author_id variable.
SELECT MAX(author_id) INTO p_author_id 
  FROM authors; 

-- And this is the end of the 
-- conditional stuff.
END IF; 
</code></pre>
<p>&ndash; And we&rsquo;re back to doing the same stuff
&ndash; as last time.
INSERT INTO books (book_id, title, genre)
VALUES (p_book_id, p_title, p_genre);</p>
<p>INSERT INTO authorship (author_id, book_id)
VALUES (p_author_id, p_book_id);</p>
<p>END //<!-- raw HTML omitted --><!-- raw HTML omitted -->
<!-- raw HTML omitted -->&ndash; But there&rsquo;s a problem&hellip;
&ndash; Our procedure is going to create
&ndash; a new author every time we add a book!</p>
<p>&ndash; Let&rsquo;s start over
DROP PROCEDURE insert_book</p>
<p>&ndash; Same stuff as last time&hellip;
DELIMITER // ;</p>
<p>CREATE PROCEDURE insert_book(
IN p_title TEXT,
IN p_genre VARCHAR(200),
IN p_author_first_name VARCHAR(50),
IN p_author_last_name VARCHAR(50)
)</p>
<p>&ndash; Still the same stuff&hellip;
BEGIN</p>
<p>DECLARE p_book_id INT;
DECLARE p_author_id INT;</p>
<p>&ndash; Something new!
&ndash; We&rsquo;re creating the protocol for
&ndash; what happens when we get an error
&ndash; with the code &lsquo;1242&rsquo;.</p>
<p>DECLARE EXIT HANDLER FOR 1242
BEGIN
&ndash; &lsquo;ROLLBACK&rsquo; means &ldquo;Even if you
&ndash; inserted a bunch of rows already,
&ndash; undo everything if there&rsquo;s an error&rdquo;.
ROLLBACK;</p>
<pre><code>  -- This is the message we return.
    SELECT CONCAT('Looks like ',
      'you have multiple authors ',
      'by the name ', 
      p_author_first_name, ' ',
      p_author_last_name);
END;
</code></pre>
<p>&ndash; This is the same as last time
SELECT MAX(book_id) + 1 INTO p_book_id
FROM books;</p>
<p>&ndash; This is new!</p>
<p>&ndash; If the author already exists&hellip;
IF (
SELECT author_id FROM authors
WHERE first_name = p_author_first_name
AND last_name = p_author_last_name
)</p>
<p>THEN</p>
<p>&ndash; &hellip;select the existing author_id
&ndash; into the p_author_id variable
SELECT author_id INTO p_author_id
FROM authors
WHERE first_name = p_author_first_name
AND last_name = p_author_last_name;</p>
<p>&ndash; Okay, quick aside - remember error 1242?
&ndash; That&rsquo;s the number of the error we get if
&ndash; the above SELECT statement returns more
&ndash; than one result! Aaaaand back to talking
&ndash; about the if/else code:</p>
<p>&ndash; However, if the author doesn&rsquo;t
&ndash; already exist&hellip;
ELSE</p>
<pre><code>-- ...create a new author...
INSERT INTO authors (author_id, 
  first_name, last_name) 
  VALUES (NULL, p_author_first_name, 
    p_author_last_name);
-- ...and then select the new author's 
-- id into the p_author_id variable.
SELECT MAX(author_id) INTO p_author_id 
  FROM authors; 

-- And this is the end of the 
-- conditional stuff.
END IF; 
</code></pre>
<p>&ndash; And we&rsquo;re back to doing the same stuff
&ndash; as last time.
INSERT INTO books (book_id, title, genre)
VALUES (p_book_id, p_title, p_genre);</p>
<p>INSERT INTO authorship (author_id, book_id)
VALUES (p_author_id, p_book_id);</p>
<p>END //<!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<p>CALL insert_book(&lsquo;The Haunted Mask&rsquo;, &lsquo;Horror&rsquo;, &lsquo;R.L.', &lsquo;Stine&rsquo;);
CALL insert_book(&lsquo;One Day at Horrorland&rsquo;, &lsquo;Horror&rsquo;, &lsquo;R.L.', &lsquo;Stine&rsquo;);
CALL insert_book(&lsquo;The Curse of the Mummy'&lsquo;s Tomb&rsquo;, &lsquo;Horror&rsquo;, &lsquo;R.L.', &lsquo;Stine&rsquo;);
CALL insert_book(&lsquo;The Werewolf of Fever Swamp&rsquo;, &lsquo;Horror&rsquo;, &lsquo;R.L.', &lsquo;Stine&rsquo;);
CALL insert_book(&lsquo;The Scarecrow Walks at Midnight&rsquo;, &lsquo;Horror&rsquo;, &lsquo;R.L.', &lsquo;Stine&rsquo;);
CALL insert_book(&lsquo;Return of the Mummy&rsquo;, &lsquo;Horror&rsquo;, &lsquo;R.L.', &lsquo;Stine&rsquo;);
CALL insert_book(&lsquo;A Revolta dos Gnomos&rsquo;, &lsquo;Horror&rsquo;, &lsquo;R.L.', &lsquo;Stine&rsquo;);
CALL insert_book(&lsquo;Vampire Breath&rsquo;, &lsquo;Horror&rsquo;, &lsquo;R.L.', &lsquo;Stine&rsquo;);
CALL insert_book(&lsquo;Stay Out of the Basement&rsquo;, &lsquo;Horror&rsquo;, &lsquo;R.L.', &lsquo;Stine&rsquo;);
CALL insert_book(&lsquo;Night of the Living Dummy II&rsquo;, &lsquo;Horror&rsquo;, &lsquo;R.L.', &lsquo;Stine&rsquo;);
CALL insert_book(&lsquo;The Ghost Next Door&rsquo;, &lsquo;Horror&rsquo;, &lsquo;R.L.', &lsquo;Stine&rsquo;);<!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<p>INSERT INTO withdrawals (withdrawal_id, member_id,book_id) VALUES (NULL, 2,4),(NULL, 2,4),(NULL, 2,13),(NULL, 3,4),(NULL, 2,6),(NULL, 3,14),(NULL, 1,15),(NULL, 3,4);
INSERT INTO withdrawals (withdrawal_id, member_id,book_id) VALUES (NULL, 3,10),(NULL, 3,10),(NULL, 2,2),(NULL, 1,3),(NULL, 3,10),(NULL, 2,5),(NULL, 2,1),(NULL, 2,6),(NULL, 2,11);
&ndash; etc (see notes)<!-- raw HTML omitted --><!-- raw HTML omitted -->
<!-- raw HTML omitted -->INSERT INTO members VALUES (NULL, &lsquo;Simon&rsquo;, &lsquo;Borer&rsquo;);
INSERT INTO members VALUES (NULL, &lsquo;John&rsquo;, &lsquo;Joseph&rsquo;);
INSERT INTO members VALUES (NULL, &lsquo;Ian&rsquo;, &lsquo;MacKaye&rsquo;);</p>
<p>INSERT INTO withdrawals (withdrawal_id, member_id,book_id) VALUES (NULL, 2,4),(NULL, 2,4),(NULL, 2,13),(NULL, 3,4),(NULL, 2,6),(NULL, 3,14),(NULL, 1,15),(NULL, 3,4);
INSERT INTO withdrawals (withdrawal_id, member_id,book_id) VALUES (NULL, 3,10),(NULL, 3,10),(NULL, 2,2),(NULL, 1,3),(NULL, 3,10),(NULL, 2,5),(NULL, 2,1),(NULL, 2,6),(NULL, 2,11);
INSERT INTO withdrawals (withdrawal_id, member_id,book_id) VALUES (NULL, 1,5),(NULL, 1,10),(NULL, 2,13),(NULL, 1,7),(NULL, 2,3),(NULL, 1,15),(NULL, 2,9),(NULL, 1,10),(NULL, 2,12);
INSERT INTO withdrawals (withdrawal_id, member_id,book_id) VALUES (NULL, 3,12),(NULL, 1,13),(NULL, 2,13),(NULL, 2,15),(NULL, 1,8),(NULL, 1,13),(NULL, 2,8),(NULL, 1,15);
INSERT INTO withdrawals (withdrawal_id, member_id,book_id) VALUES (NULL, 3,1),(NULL, 3,6),(NULL, 2,15),(NULL, 1,1),(NULL, 3,1),(NULL, 3,11),(NULL, 2,6),(NULL, 2,13),(NULL, 2,5),(NULL, 3,3);
INSERT INTO withdrawals (withdrawal_id, member_id,book_id) VALUES (NULL, 3,5),(NULL, 3,5),(NULL, 3,6),(NULL, 1,6),(NULL, 3,10),(NULL, 3,8),(NULL, 3,6),(NULL, 1,9);
INSERT INTO withdrawals (withdrawal_id, member_id,book_id) VALUES (NULL, 2,14),(NULL, 3,14),(NULL, 2,12),(NULL, 1,1),(NULL, 3,7),(NULL, 1,9),(NULL, 3,1),(NULL, 3,15),(NULL, 2,7);
INSERT INTO withdrawals (withdrawal_id, member_id,book_id) VALUES (NULL, 1,7),(NULL, 3,14),(NULL, 1,1),(NULL, 2,11),(NULL, 2,13),(NULL, 2,7),(NULL, 3,5),(NULL, 1,1),(NULL, 3,7);
INSERT INTO withdrawals (withdrawal_id, member_id,book_id) VALUES (NULL, 2,9),(NULL, 2,14),(NULL, 1,10),(NULL, 3,7),(NULL, 2,12),(NULL, 1,11),(NULL, 1,9),(NULL, 3,8),(NULL, 3,3);
INSERT INTO withdrawals (withdrawal_id, member_id,book_id) VALUES (NULL, 3,4),(NULL, 1,2),(NULL, 3,6),(NULL, 3,2),(NULL, 2,9),(NULL, 1,10),(NULL, 3,3),(NULL, 3,4);INSERT INTO withdrawals (withdrawal_id, member_id,book_id) VALUES (NULL, 2,4),(NULL, 2,4),(NULL, 2,13),(NULL, 3,4),(NULL, 2,6),(NULL, 3,14),(NULL, 1,15),(NULL, 3,4);
INSERT INTO withdrawals (withdrawal_id, member_id,book_id) VALUES (NULL, 3,10),(NULL, 3,10),(NULL, 2,2),(NULL, 1,3),(NULL, 3,10),(NULL, 2,5),(NULL, 2,1),(NULL, 2,6),(NULL, 2,11);
INSERT INTO withdrawals (withdrawal_id, member_id,book_id) VALUES (NULL, 1,5),(NULL, 1,10),(NULL, 2,13),(NULL, 1,7),(NULL, 2,3),(NULL, 1,15),(NULL, 2,9),(NULL, 1,10),(NULL, 2,12);
INSERT INTO withdrawals (withdrawal_id, member_id,book_id) VALUES (NULL, 3,12),(NULL, 1,13),(NULL, 2,13),(NULL, 2,15),(NULL, 1,8),(NULL, 1,13),(NULL, 2,8),(NULL, 1,15);
INSERT INTO withdrawals (withdrawal_id, member_id,book_id) VALUES (NULL, 3,1),(NULL, 3,6),(NULL, 2,15),(NULL, 1,1),(NULL, 3,1),(NULL, 3,11),(NULL, 2,6),(NULL, 2,13),(NULL, 2,5),(NULL, 3,3);
INSERT INTO withdrawals (withdrawal_id, member_id,book_id) VALUES (NULL, 3,5),(NULL, 3,5),(NULL, 3,6),(NULL, 1,6),(NULL, 3,10),(NULL, 3,8),(NULL, 3,6),(NULL, 1,9);
INSERT INTO withdrawals (withdrawal_id, member_id,book_id) VALUES (NULL, 2,14),(NULL, 3,14),(NULL, 2,12),(NULL, 1,1),(NULL, 3,7),(NULL, 1,9),(NULL, 3,1),(NULL, 3,15),(NULL, 2,7);
INSERT INTO withdrawals (withdrawal_id, member_id,book_id) VALUES (NULL, 1,7),(NULL, 3,14),(NULL, 1,1),(NULL, 2,11),(NULL, 2,13),(NULL, 2,7),(NULL, 3,5),(NULL, 1,1),(NULL, 3,7);
INSERT INTO withdrawals (withdrawal_id, member_id,book_id) VALUES (NULL, 2,9),(NULL, 2,14),(NULL, 1,10),(NULL, 3,7),(NULL, 2,12),(NULL, 1,11),(NULL, 1,9),(NULL, 3,8),(NULL, 3,3);
INSERT INTO withdrawals (withdrawal_id, member_id,book_id) VALUES (NULL, 3,4),(NULL, 1,2),(NULL, 3,6),(NULL, 3,2),(NULL, 2,9),(NULL, 1,10),(NULL, 3,3),(NULL, 3,4);<!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<p>&ndash; Here we define the datatype of the return value
RETURNS DECIMAL(30,5)</p>
<p>BEGIN
&ndash; Declare a variable we&rsquo;ll use inside the function
DECLARE conversion DECIMAL(7,6);
&ndash; Set the value of the variable
SELECT 0.621371 INTO conversion;
&ndash; Return the value<br>
RETURN (miles * conversion);
&ndash; And we&rsquo;re done!
END$$<!-- raw HTML omitted --><!-- raw HTML omitted -->
<!-- raw HTML omitted -->&ndash; Define our delimiter
DELIMITER $$</p>
<p>&ndash; Create statement names our
&ndash; function and defines the argument(s)
CREATE FUNCTION miles_to_km(
miles DECIMAL
)</p>
<p>&ndash; Here we define the datatype of the
&ndash; return value
RETURNS DECIMAL(30,5)</p>
<p>&ndash; And then we start!
BEGIN</p>
<p>&ndash; Declare a variable we&rsquo;ll use
&ndash; inside the function
DECLARE conversion DECIMAL(7,6);</p>
<p>&ndash; Set the value of the variable
SELECT 0.621371 INTO conversion;</p>
<p>&ndash; Return the value<br>
RETURN (miles * conversion);</p>
<p>&ndash; And we&rsquo;re done!
END$$<!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<pre><code>-- What genre does the member withdraw most frequently?

-- Get the member's most frequently
-- borrowed genre, and store it
-- in the `f_genre` variable.
-- Store the count in another variable,
-- not because we'll need it later, but
-- because otherwise SQL will try
-- to put it into the f_genre variable,
-- too.
SELECT genre, COUNT(*) INTO f_genre, f_genre_count
  FROM withdrawals w 
    JOIN books b
  ON w.book_id = b.book_id
  WHERE member_id = f_member_id
  GROUP BY genre
  ORDER BY COUNT(*) DESC
  LIMIT 1;
  
-- What is the most popular book of 
-- that genre that has not 
-- been withdrawn by this member

-- Put the title into the 
-- `f_recommendation` variable
SELECT b.title INTO f_recommendation
  FROM withdrawals w 
    JOIN books b
  ON w.book_id = b.book_id
  -- of the most popular book
  -- of the member's favourite genre
  -- excluding those books
  -- that the member has checked
  -- out in the past.
  WHERE genre = f_genre AND b.book_id NOT IN (
    SELECT book_id FROM withdrawals WHERE member_id = f_member_id
  )
  GROUP BY b.book_id, title
  ORDER BY COUNT(*) DESC
  LIMIT 1;

RETURN (f_recommendation);
</code></pre>
<p>END //<br>
<!-- raw HTML omitted --><!-- raw HTML omitted -->
<!-- raw HTML omitted -->DELIMITER // ;
&ndash; Take a member id as the argument
CREATE FUNCTION recommendation(
f_member_id INT
)
RETURNS TEXT
BEGIN
&ndash; We&rsquo;re going to use three variables
DECLARE f_genre VARCHAR(200);
DECLARE f_recommendation TEXT;
DECLARE f_genre_count INT;</p>
<pre><code>-- What genre does the member withdraw 
-- most frequently?

-- Get the member's most frequently
-- borrowed genre, and store it
-- in the `f_genre` variable.
-- Store the count in another variable,
-- not because we'll need it later, but
-- because otherwise SQL will try
-- to put it into the f_genre variable,
-- too.
SELECT genre, COUNT(*) INTO 
  f_genre, 
  f_genre_count
  FROM withdrawals w 
    JOIN books b
  ON w.book_id = b.book_id
  WHERE member_id = f_member_id
  GROUP BY genre
  ORDER BY COUNT(*) DESC
  LIMIT 1;
  
-- What is the most popular book of 
-- that genre that has not 
-- been withdrawn by this member

-- Put the title into the 
-- `f_recommendation` variable
SELECT b.title INTO f_recommendation
  FROM withdrawals w 
    JOIN books b
  ON w.book_id = b.book_id
  -- of the most popular book
  -- of the member's favourite genre
  -- excluding those books
  -- that the member has checked
  -- out in the past.
  WHERE genre = f_genre AND b.book_id 
    NOT IN (
      SELECT book_id FROM withdrawals 
      WHERE member_id = f_member_id
  )
  GROUP BY b.book_id, title
  ORDER BY COUNT(*) DESC
  LIMIT 1;

RETURN (f_recommendation);
</code></pre>
<p>END //<br>
<!-- raw HTML omitted -->
<!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
</div>
									
				</div>
			</div>
		</article>
	</main>

	
<script src="https://a11y2020.com/js/prism.js"></script>
<script src="https://a11y2020.com/js/codemirror.js"></script>
<script src="https://a11y2020.com/js/xml.js"></script>
<script src="https://a11y2020.com/js/css.js"></script>
<script src="https://a11y2020.com/js/javascript.js"></script>
<script src="https://a11y2020.com/js/htmlmixed.js"></script>
<script src="https://a11y2020.com/js/sql.js"></script>
<script type="text/javascript">
function qsa(sel) {
	return Array.apply(null, document.querySelectorAll(sel));
}
qsa('[data-code-mirror="html"]').forEach(function (editorEl) {
	var mirror = CodeMirror.fromTextArea(editorEl, {
		lineNumbers: true,
		mode: 'htmlmixed',
		theme: 'material'
	});
	if (editorEl.hasAttribute("data-code-mirror-height")) {
		var setHeight = editorEl.getAttribute("data-code-mirror-height");
		mirror.setSize(null, setHeight);
	}
});
qsa('[data-code-mirror="sql"]').forEach(function (editorEl) {
	var mirror = CodeMirror.fromTextArea(editorEl, {
		lineNumbers: true,
		mode: 'sql',
		theme: 'material'
	});
	if (editorEl.hasAttribute("data-code-mirror-height")) {
		var setHeight = editorEl.getAttribute("data-code-mirror-height");
		mirror.setSize(null, setHeight);
	}
});
</script>

</body>
</html>
